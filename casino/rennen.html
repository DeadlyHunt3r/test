<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Pferde Rennen - Lucky Panda</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    header {
      width: 100%;
      background: rgba(44,44,46,0.9);
      padding: 16px 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .title { font-size: 24px; font-weight: bold; }
    .nav-right a {
      background: #D4AF37;
      color: #1c1c1e;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      margin-left: 8px;
      transition: background 0.3s;
    }
    .nav-right a:hover { background: #C39B2E; }
    .user-display {
      width: 100%;
      background: rgba(44,44,46,0.8);
      padding: 8px 24px;
      font-size: 16px;
      color: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.5);
      display: flex;
      justify-content: flex-start;
      gap: 24px;
    }
    main {
      flex: 1;
      padding: 24px;
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .track {
      margin: 16px 0;
      height: 24px;
      background: #333;
      border-radius: 12px;
      overflow: hidden;
    }
    .bar {
      height: 100%;
      width: 0;
      background: #D4AF37;
      transition: width 2s ease-out;
    }
    .controls {
      margin-top: 24px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    select, input[type=number] {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      background: #3a3a3c;
      color: #fff;
      font-size: 16px;
    }
    button.play {
      background: #D4AF37;
      color: #1c1c1e;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button.play:hover { background: #C39B2E; }
  </style>
</head>
<body>
  <header>
    <div class="title">Pferde Rennen</div>
    <div class="nav-right">
      <a href="casino.html">Zurück</a>
    </div>
  </header>
  <div class="user-display">
    <span>Benutzer: <strong id="username">Lade…</strong></span>
    <span>Coins: <strong id="coins">Lade…</strong></span>
  </div>
  <main>
    <div id="tracks"></div>
    <div class="controls">
      <label for="horse">Pferd:</label>
      <select id="horse"></select>
      <label for="bet">Einsatz:</label>
      <input id="bet" type="number" value="1000" min="1000" max="5000" step="100" />
      <button class="play" id="playBtn">Rennen!</button>
    </div>
  </main>
  <script>
    // Elemente
    const usernameEl = document.getElementById('username');
    const coinsEl = document.getElementById('coins');
    const currentUser = localStorage.getItem('currentUser');

    // Anzeige Benutzer
    usernameEl.textContent = currentUser || 'Nicht eingeloggt';

    // Konfiguration
    const odds = [1.2, 1.5, 2.0, 2.5, 3.0, 4.0];
    const horses = odds.map((q,i)=>({id:i, name:`Pferd ${i+1}`, quota:q}));
    const tracksEl = document.getElementById('tracks');
    const horseSel = document.getElementById('horse');
    const betInput = document.getElementById('bet');
    const playBtn = document.getElementById('playBtn');

    horses.forEach(h=>{
      const track = document.createElement('div'); track.className = 'track';
      const bar = document.createElement('div'); bar.className = 'bar'; bar.id = `bar${h.id}`;
      track.append(bar); tracksEl.append(track);
      const opt = document.createElement('option'); opt.value = h.id;
      opt.textContent = `${h.name} (${h.quota}x)`; horseSel.append(opt);
    });

    const apiUrl = 'https://script.google.com/macros/s/AKfycbxdb_bo-KKqIf1yyQQlbI3nRPw_moF9QWY0ltpLxFy87mvOOAPumi6RUFekfUmEXEhy/exec';
    let coins = 0;

    // Coins holen und anzeigen
    async function loadCoins(){
      if(!currentUser) return;
      const res = await fetch(`${apiUrl}?search=${encodeURIComponent(JSON.stringify({username:currentUser}))}`);
      const arr = await res.json();
      const me = arr.find(u=>u.username===currentUser);
      coins = me?.coins||0;
      coinsEl.textContent = coins.toLocaleString('de-DE');
    }

    // Coins updaten und anzeigen
    async function updateCoins(newVal){
      if(!currentUser) return;
      coins = newVal; localStorage.setItem('coins',coins);
      coinsEl.textContent = coins.toLocaleString('de-DE');
      await fetch(apiUrl, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username:currentUser, coins:coins})
      });
    }

    // Rennen starten
    playBtn.addEventListener('click', async ()=>{
      const choice = parseInt(horseSel.value);
      const bet = Number(betInput.value);
      if(!currentUser||bet<1000||bet>5000||bet>coins) return alert('Ungültiger Einsatz');
      await loadCoins();
      const dist = horses.map((h,i)=>(i===choice?1/h.quota:1));
      const sum = dist.reduce((a,b)=>a+b,0);
      const rnd = Math.random()*sum; let acc=0, winner=0;
      dist.forEach((d,i)=>{acc+=d; if(rnd<acc) winner=i;});
      horses.forEach((h,i)=>{
        document.getElementById(`bar${i}`).style.width = (i===winner? '100%' : `${Math.random()*80+10}%`);
      });
      setTimeout(async ()=>{
        let newCoins = coins - bet;
        if(winner===choice) newCoins += Math.floor(bet*horses[choice].quota);
        await updateCoins(newCoins);
        alert(winner===choice? 'Gewonnen!' : 'Verloren!');
      }, 2000);
    });

    // Initial
    loadCoins();
  </script>
</body>
</html>